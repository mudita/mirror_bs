ifndef MK_PACMAN_MK
MK_PACMAN_MK=			TRUE

INCLUDER_MODULES_LIST=		config \
				dirs

ifndef INCLUDER_PATH
$(error tool modbuild is not installed in your build system!)
else
include $(INCLUDER_PATH)
endif

PACMAN_PKGBUILD_FILE_NAME=	PKGBUILD

PACMAN_CI_USER_NAME=		ci

PACMAN_EXT=			pkg.tar.xz

PACMAN_WHOAMI_USER_ID_COMMAND=	id \
					-u

PACMAN_WHOAMI_USER_ID=		$(shell \
					$(PACMAN_WHOAMI_USER_ID_COMMAND))

PACMAN_PLATFORM_DIR=		$(DIRS_PACMAN_DIR)/$(PLATFORM)

PACMAN_PKGBUILD_SRC_FILE=	$(PACMAN_PKGBUILD_FILE_NAME)
PACMAN_PKGBUILD_DEST_FILE=	$(PACMAN_PLATFORM_DIR)/$(PACMAN_PKGBUILD_FILE_NAME)

PACMAN_TOOL_ARCHIVE_FILE=	$(PACMAN_PLATFORM_DIR)/$(SIGNATURE_TOOL_FILE_NAME).$(CONFIG_TAR_GZ_EXT)

PACMAN_PACK_LIST_COMMAND=	ls \
					$(INSTALL_PLATFORM_DIR)

PACMAN_PACK_LIST=		$(shell \
					$(PACMAN_PACK_LIST_COMMAND))

PACMAN_SUMS_LIST_COMMAND=	sha256sum \
					$(PACMAN_PLATFORM_DIR)/$* | \
				cut \
					-c-64

PACMAN_NAME_SED_PATTERN=	s\|\%PKGNAME\%\|$(SIGNATURE_TOOL_FILE_NAME)\|g
PACMAN_SOURCES_SED_PATTERN=	s\|\%SOURCE\%\|\"$*\"\|g
PACMAN_SUMS_SED_PATTERN=	\"s\|\%%SHA256SUMS\%%\|%s\|g\"\ -i\ $(PACMAN_PKGBUILD_DEST_FILE)

PACMAN_GEN_NAME_COMMAND=	sed \
					$(PACMAN_NAME_SED_PATTERN) \
					-i \
					$(PACMAN_PKGBUILD_DEST_FILE)

PACMAN_GEN_SOURCES_COMMAND=	sed \
					$(PACMAN_SOURCES_SED_PATTERN) \
					-i \
					$(PACMAN_PKGBUILD_DEST_FILE)

PACMAN_GEN_SUMS_COMMAND=	$(PACMAN_SUMS_LIST_COMMAND) | \
					xargs \
					printf \
					$(PACMAN_SUMS_SED_PATTERN) | \
					xargs \
					sed

ifneq ($(PACMAN_WHOAMI_USER_ID), 0)
PACMAN_MAKEPKG_COMMAND=		cd \
					$(PACMAN_PLATFORM_DIR) && \
				makepkg \
					-s
else
PACMAN_MAKEPKG_COMMAND=		chmod \
					775 \
					$(PACMAN_PLATFORM_DIR) && \
				cd \
					$(PACMAN_PLATFORM_DIR) && \
				su \
				$(PACMAN_CI_USER_NAME) \
				-c \
				makepkg\ -s
endif

PACMAN_KEY_VALUE_DELIMETER=	=

PACMAN_VERSION_KEY_NAME=	pkgver
PACMAN_RELEASE_KEY_NAME=	pkgrel
PACMAN_ARCH_KEY_NAME=		arch

PACMAN_VERSION_PATTERN=		$(PACMAN_VERSION_KEY_NAME)$(PACMAN_KEY_VALUE_DELIMETER)
PACMAN_RELEASE_PATTERN=		$(PACMAN_RELEASE_KEY_NAME)$(PACMAN_KEY_VALUE_DELIMETER)
PACMAN_ARCH_PATTERN=		$(PACMAN_ARCH_KEY_NAME)$(PACMAN_KEY_VALUE_DELIMETER)

PACMAN_GET_ONLY_VALUE_COMMAND=	cut \
					-d \
					$(PACMAN_KEY_VALUE_DELIMETER) \
					-f \
					2

PACMAN_TRIM_COMMAND=		tr \
					-d \
					\' | \
				tr \
					-d \
					\( | \
				tr \
					-d \
					\)

PACMAN_ARCHIVE_VERSION_COMMAND=	grep \
					$(PACMAN_VERSION_PATTERN) \
					$(PACMAN_PKGBUILD_SRC_FILE) | \
				$(PACMAN_GET_ONLY_VALUE_COMMAND) | \
				$(PACMAN_TRIM_COMMAND)

PACMAN_ARCHIVE_RELEASE_COMMAND=	grep \
					$(PACMAN_RELEASE_PATTERN) \
					$(PACMAN_PKGBUILD_SRC_FILE) | \
				$(PACMAN_GET_ONLY_VALUE_COMMAND) | \
				$(PACMAN_TRIM_COMMAND)

PACMAN_ARCHIVE_ARCH_COMMAND=	grep \
					$(PACMAN_ARCH_PATTERN) \
					$(PACMAN_PKGBUILD_SRC_FILE) | \
				$(PACMAN_GET_ONLY_VALUE_COMMAND) | \
				$(PACMAN_TRIM_COMMAND)

ifneq ($(wildcard $(PACMAN_PKGBUILD_SRC_FILE)), )
PACMAN_ARCHIVE_VERSION=		$(shell \
					$(PACMAN_ARCHIVE_VERSION_COMMAND))

PACMAN_ARCHIVE_RELEASE=		$(shell \
					$(PACMAN_ARCHIVE_RELEASE_COMMAND))

PACMAN_ARCHIVE_ARCH=		$(shell \
					$(PACMAN_ARCHIVE_ARCH_COMMAND))
else
PACMAN_ARCHIVE_VERSION=
PACMAN_ARCHIVE_RELEASE=
PACMAN_ARCHIVE_ARCH=
endif

endif

