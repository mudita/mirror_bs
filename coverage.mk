ifndef MK_COVERAGE_MK
MK_COVERAGE_MK=			TRUE

INCLUDER_MODULES_LIST=		config \
				name \
				dirs \
				sources/c \
				platform

ifndef INCLUDER_PATH
$(error tool modbuild is not installed in your build system!)
else
include $(INCLUDER_PATH)
endif

# TODO: Implement rules for gcno and gcda files.
COVERAGE_GCOV_DIR_NAME=		$(CONFIG_GCOV_FILE_EXT)
COVERAGE_LCOV_DIR_NAME=		$(CONFIG_LCOV_FILE_EXT)
COVERAGE_HTML_DIR_NAME=		$(CONFIG_HTML_FILE_EXT)

COVERAGE_PLATFORM_DIR=		$(DIRS_COVERAGE_DIR)/$(PLATFORM)
COVERAGE_OBJECT_PLATFORM_DIR=	$(DIRS_OBJECTS_DIR)/$(PLATFORM)

COVERAGE_GCOV_PLATFORM_DIR=	$(COVERAGE_PLATFORM_DIR)/$(COVERAGE_GCOV_DIR_NAME)
COVERAGE_LCOV_PLATFORM_DIR=	$(COVERAGE_PLATFORM_DIR)/$(COVERAGE_LCOV_DIR_NAME)
COVERAGE_HTML_PLATFORM_DIR=	$(COVERAGE_PLATFORM_DIR)/$(COVERAGE_HTML_DIR_NAME)

COVERAGE_GCOV_ASM_LIST=		$(patsubst \
					$(DIRS_SOURCES_DIR)/%, \
					$(COVERAGE_GCOV_PLATFORM_DIR)/%.$(CONFIG_GCOV_FILE_EXT), \
					$(SOURCES_ASM_LIST))

COVERAGE_GCDA_ASM_LIST=		$(patsubst \
					$(COVERAGE_OBJECT_PLATFORM_DIR)/%_for_test_$(SIGNATURE_ASM_OBJECT_SUFFIX), \
					$(COVERAGE_OBJECT_PLATFORM_DIR)/%_for_test_$(SIGNATURE_ASM_GCDA_SUFFIX), \
					$(OBJECTS_ASM_FOR_TEST_LIST))

COVERAGE_GCOV_C_LIST=		$(patsubst \
					$(DIRS_SOURCES_DIR)/%, \
					$(COVERAGE_GCOV_PLATFORM_DIR)/%.$(CONFIG_GCOV_FILE_EXT), \
					$(SOURCES_C_LIST))

COVERAGE_GCDA_C_LIST=		$(patsubst \
					$(COVERAGE_OBJECT_PLATFORM_DIR)/%_for_test_$(SIGNATURE_C_OBJECT_SUFFIX), \
					$(COVERAGE_OBJECT_PLATFORM_DIR)/%_for_test_$(SIGNATURE_C_GCDA_SUFFIX), \
					$(OBJECTS_C_FOR_TEST_LIST))

##############################################################################
# INFO: Dependency mechanism.
##############################################################################
# TODO: This code is present in includes.mk, libs.mk and coverage.mk - merge it!
COVERAGE_DEP_GENERIC_FILE_NAME=		$(CONFIG_MODULE_DEP_FILE_NAME)
COVERAGE_DEP_PLATFORM_FILE_NAME=	$(CONFIG_MODULE_PREFIX)s_$(PLATFORM).$(CONFIG_DEP_EXT)

COVERAGE_DEPENDENCIES_EXISTENCE=	$(wildcard \
						$(COVERAGE_DEP_GENERIC_FILE_NAME))

COVERAGE_DEPENDENCIES_PLAT_EXISTENCE=	$(wildcard \
						$(COVERAGE_DEP_PLATFORM_FILE_NAME))

ifneq ($(COVERAGE_DEPENDENCIES_EXISTENCE), )
COVERAGE_DEPENDENCIES_COMMAND=	cat \
					$(COVERAGE_DEP_GENERIC_FILE_NAME)

COVERAGE_MODULES_LIST=		$(shell \
					$(COVERAGE_DEPENDENCIES_COMMAND))
else ifneq ($(COVERAGE_DEPENDENCIES_PLAT_EXISTENCE), )
COVERAGE_DEPENDENCIES_COMMAND=	cat \
					$(COVERAGE_DEP_PLATFORM_FILE_NAME)

COVERAGE_MODULES_LIST=		$(shell \
					$(COVERAGE_DEPENDENCIES_COMMAND))
else
COVERAGE_MODULES_LIST=
endif

##############################################################################

###########################################################################################

# TODO: Check what is happenning with headers files generated by gcov.

###########################################################################################

COVERAGE_CHECK_MODULE_DIR=		$(DIRS_MODULES_DIR)/$($(CONFIG_MODULE_PREFIX))/$(DIRS_SOURCES_DIR)

COVERAGE_CHECK_MODULE_RELATIVE_DIR=	$(RELATIVE_ROOT_DIR)/$(COVERAGE_CHECK_MODULE_DIR)

COVERAGE_SOURCES_DIR_TEST_CONDITION=	$(wildcard \
						$(COVERAGE_CHECK_MODULE_RELATIVE_DIR))

COVERAGE_SOURCES_DIR_TEST_TRUE_COMMAND=		ls \
							$(COVERAGE_CHECK_MODULE_RELATIVE_DIR)

COVERAGE_SOURCES_DIR_TEST_FALSE_COMMAND=	true

COVERAGE_SOURCES_DIR_TEST_COMMAND=	$(if \
						$(COVERAGE_SOURCES_DIR_TEST_CONDITION), \
						$(COVERAGE_SOURCES_DIR_TEST_TRUE_COMMAND), \
						$(COVERAGE_SOURCES_DIR_TEST_FALSE_COMMAND))

COVERAGE_SOURCES_DIR_TEST=		$(shell	\
						$(COVERAGE_SOURCES_DIR_TEST_COMMAND))

COVERAGE_SOURCES_DIR_NOT_EMPTY_TRUE=	$($(CONFIG_MODULE_PREFIX))

COVERAGE_SOURCES_DIR_NOT_EMPTY_FALSE=

COVERAGE_SOURCES_DIR_NOT_EMPTY_TEST=	$(if \
						$(COVERAGE_SOURCES_DIR_TEST), \
						$(COVERAGE_SOURCES_DIR_NOT_EMPTY_TRUE), \
						$(COVERAGE_SOURCES_DIR_NOT_EMPTY_FALSE))

COVERAGE_MODULES_WITH_SOURCES_LIST=	$(foreach \
						$(CONFIG_MODULE_PREFIX), \
						$(COVERAGE_MODULES_LIST), \
						$(COVERAGE_SOURCES_DIR_NOT_EMPTY_TEST))

###########################################################################################

# TODO: Put into platform directory
COVERAGE_APPLICATION_PREFIX=	$(COVERAGE_LCOV_PLATFORM_DIR)/$(CONFIG_APPLICATION_PREFIX)
COVERAGE_MODULE_PREFIX=		$(COVERAGE_LCOV_PLATFORM_DIR)/$(CONFIG_MODULE_PREFIX)

COVERAGE_APPLICATION_FILE=	$(COVERAGE_APPLICATION_PREFIX)_$(NAME).$(CONFIG_LCOV_FILE_EXT)

COVERAGE_MODULE_FILE_LIST=	$(patsubst \
					%, \
					$(COVERAGE_MODULE_PREFIX)_%.$(CONFIG_LCOV_FILE_EXT), \
					$(COVERAGE_MODULES_WITH_SOURCES_LIST))

endif

